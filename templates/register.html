{% extends "base.html" %}
{% block title %}Register - Todo App{% endblock %}
{% block additional_styling %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/register.css') }}">
{% endblock %}

{% block content %}

<div class="container register-container">
    <h2>Register Account</h2>

    <form method="POST" novalidate>
        <input type="text" name="username" placeholder="Username" value="{{ request.form.username or '' }}" required
            autocomplete="username">

        <input type="email" name="email" placeholder="Email" value="{{ request.form.email or '' }}" required
            autocomplete="email">

        <input type="password" name="password" placeholder="Password" required autocomplete="new-password">

        <select title="Group" name="group" required>
            <option value="" disabled selected>Choose your group</option>
            {% for group in groups %}
            <option value="{{ group.name }}">{{ group.name }}</option>
            {% endfor %}
        </select>

        <!-- Lame Captcha Section -->
        <div class="lame-captcha">
            <p class="captcha-question">Answer in 1 word: {{ captcha_question }}</p>
            <input type="text" name="captcha_answer" placeholder="Your answer" required autocomplete="off">
            <input type="hidden" name="captcha_expected" value="{{ captcha_expected }}">
        </div>

        <button type="submit">Register</button>
    </form>

    <p>Already have an account?<a href="/login" class="register-link">Sign in</a></p>
</div>
{% endblock %}
{% block scripts %}
<script>
    async function loadGroups() {
        try {
            console.log('Loading groups from API...');
            const response = await fetch('/api/registration/groups');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const groups = await response.json();
            console.log('Groups received:', groups);

            const select = document.querySelector('select[name="group"]');
            select.innerHTML = '<option value="" disabled selected>Choose your group</option>';

            groups.forEach(group => {
                const option = document.createElement('option');
                // Use lowercase for value to match DB, but nice display name
                option.value = group.name.toLowerCase();  // lowercase for DB match
                option.textContent = group.description || group.name;  // nice display
                console.log(`Adding option: value="${group.name.toLowerCase()}", text="${group.description}"`);
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Failed to load groups:', error);
            const select = document.querySelector('select[name="group"]');
            select.innerHTML = '<option value="" disabled>Error loading groups</option>';
        }
    }

    document.addEventListener('DOMContentLoaded', loadGroups);
</script>
{% endblock %}